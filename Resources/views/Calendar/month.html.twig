{# Create a table to represent the monthly calendar with the td's being the day and th being the names of the days #}
<div class='calendar-month'>
    <table class='calendar-month-layout'>
        <tr class='calendar-days-header'>
            <th>Sunday</th>
            <th>Monday</th>
            <th>Tuesday</th>
            <th>Wednesday</th>
            <th>Thursday</th>
            <th>Friday</th>
            <th>Saturday</th>
        </tr>
        {# START WEEK LOOP #}
        {% for w in range(0, 5) %}
        {# MULTIDAY EVENT LOOP #}
            {# This creates an empty div that stretches a whole week between the bottom of the date number and the bottom of the day cell #}
            <tr><td colspan='7' class='calendar-multiday-bar'>
                <div class='calendar-multiday-event-container'>
                    {% if (month_start.format('Y-m-d') < start|date_modify('+1 week')|date('Y-m-d') and month_end.format('Y-m-d') >= start|date_modify(['+', w, ' week']|join)|date('Y-m-d')) %}
                        {# MULTIDAY #}
                        {% for event in events if event.startDate.format('Y-m-d') <= start|date_modify(['+', (w + 1), ' week']|join)|date('Y-m-d') and event.endDate.format('Y-m-d') >= start|date_modify(['+', w, ' week']|join)|date('Y-m-d') and event.isMultiDay %}
                            {% if event.startDate.format('Y-m-d') <= start|date_modify(['+', w, ' week']|join)|date('Y-m-d') %}
                                {% if w > 0 %}
                                    {% set sOffset = 0 %}
                                {% else %}
                                    {% set sOffset = start.diff(month_start).days %}
                                {% endif %}
                            {% else %}
                                {% set sOffset = event.startDate.diff(start|date_modify(['+', w, ' week']|join)).days %}
                            {% endif %}
                            {% if event.endDate.format('Y-m-d') >= start|date_modify(['+', (w + 1), ' week']|join)|date('Y-m-d') %}
                                {% if start|date_modify(['+', (w + 1), ' week']|join)|date('Y-m-d') <= month_end.format('Y-m-d') %}
                                    {% set eOffset = 6 %}
                                {% elseif start|date_modify(['+', w, ' week']|join)|date('Y-m-d') == month_end.format('Y-m-d')%}
                                    {% set eOffset = 0 %}
                                {% else %}
                                    {% set eOffset = month_end.diff(start|date_modify(['+', w, ' week']|join)).days %}
                                {% endif %}
                            {% else %}
                                {% set eOffset = event.endDate.diff(start|date_modify(['+', w, ' week']|join)).days %}
                            {% endif %}
                            <div class='calendar-multiday-event' style='top: 0; left: {{ sOffset * 14.3 }}%; width: {{ (eOffset - sOffset + 1) * 14.3 }}%;' draggable='true'>
                                {{ event.event|raw }}
                            </div>
                        {% endfor %}
                        {# END MULTIDAY EVENT LOOP #}
                    {% endif %}
                </div>
            </td></tr>
            <tr class='calendar-month-days'>
                {# START DAY LOOP #}
                {% for d in range(w * 7, (w * 7) + 6) %}
                    {% if start|date_modify(['+', d, ' day']|join)|date('Y-m-d') < month_start|date('Y-m-d') or start|date_modify(['+', d, ' day']|join)|date('Y-m-d') > month_end|date('Y-m-d') %}
                        <td class='calendar-month-othermonth-day'>
                            <div class='calendar-day-date'>{{ start|date_modify(['+', d, ' day']|join)|date('j') }}</div>
                        </td>
                    {% else %}
                        {# If the day is today, then give it speical theming #}
                        {% if start|date_modify(['+', d, ' day']|join)|date('Y-m-d') == 'now'|date('Y-m-d') %}
                            <td class='calendar-today'>
                        {% else %}
                            <td class='calendar-day'>
                        {% endif %}
                            <div class='calendar-day-items' style='width: 100%; height: 100%' {% for opt in day_opts if opt.date.format('Y-m-d') == start|date_modify(['+', d, ' day']|join)|date('Y-m-d') %} {{ opt.options|raw }} {% endfor %}>
                                <div class='calendar-day-date'>{{ start|date_modify(['+', d, ' day']|join)|date('j') }}</div>
                                {# SINGLE DAY EVENT LOOP #}
                                <div class='calendar-single-event-container'>
                                    {% for event in events if not event.isMultiDay and event.startDate.format('Y-m-d') == start|date_modify(['+', d, ' day']|join)|date('Y-m-d')%}
                                        <div class='calendar-single-event'>
                                            {{ event.event|raw }}
                                        </div>
                                    {% endfor %} 
                                </div>
                            </div>
                        </td>
                    {% endif %}
                {% endfor %}
                {# END DAY LOOP #}
            </tr>
        {% endfor %}
        {# END WEEK LOOP #}
    </table>
    <script type='test/javascript'>
        $('.calendar-widget').trigger('calendar-change');
    </script>
</div>